environment:
  matrix:
    # Stable channel
    - TARGET: i686-pc-windows-gnu
      TOOLCHAIN: stable
    - TARGET: i686-pc-windows-msvc
      TOOLCHAIN: stable
    - TARGET: x86_64-pc-windows-gnu
      TOOLCHAIN: stable
    - TARGET: x86_64-pc-windows-msvc
      TOOLCHAIN: stable
    # Beta channel
    - TARGET: i686-pc-windows-gnu
      TOOLCHAIN: beta
    - TARGET: i686-pc-windows-msvc
      TOOLCHAIN: beta
    - TARGET: x86_64-pc-windows-gnu
      TOOLCHAIN: beta
    - TARGET: x86_64-pc-windows-msvc
      TOOLCHAIN: beta
    # Nightly channel
    - TARGET: i686-pc-windows-gnu
      TOOLCHAIN: nightly
    - TARGET: i686-pc-windows-msvc
      TOOLCHAIN: nightly
    - TARGET: x86_64-pc-windows-gnu
      TOOLCHAIN: nightly
    - TARGET: x86_64-pc-windows-msvc
      TOOLCHAIN: nightly

install:
  - curl -sSf -o rustup-init.exe https://win.rustup.rs/
  - rustup-init.exe -y --default-host %TARGET% --default-toolchain %TOOLCHAIN%
  - set PATH=%PATH%;C:\Users\appveyor\.cargo\bin
  - choco install make -y
  - choco install msys2-installer -y
  - refreshenv
  - rustc -Vv
  - cargo -V
  - make -v
  - gcc -v

build_script:
  - git submodule -q update --init

test_script:
  - SET RUST_BACKTRACE=1
  - cargo test --target %TARGET% --all --verbose
  - cargo test --release --target %TARGET% --all --verbose
  - if [%TOOLCHAIN%]==[nightly] (
      cargo bench --target %TARGET% --all --verbose
    )
cache:
  - C:\Users\appveyor\.cargo\registry
  - target
